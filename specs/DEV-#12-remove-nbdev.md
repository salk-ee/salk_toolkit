# DEV-#12: Retire nbdev notebooks

**Last Updated**: 2025-11-18  
**Status**: ✅ Complete  
**Module**: Tooling  
**Tags**: `#nbdev`, `#migration`, `#docs`  
**Dependencies**: None

## Overview

Decommission the nbdev-based workflow so that `salk_toolkit` is maintained directly as a first-class Python package. Preserve the narrative documentation that previously lived in notebooks by porting the relevant markdown blocks into module docstrings and section comments, then delete the notebooks and nbdev config entirely.

This is done for two reasons:
- Notebooks have outlived their usefulness, as in practice we do not run code in the package notebooks
- AI tools still struggle working with .ipynb files, often doing funny things like python scripts to find relevant cells. 

## Business Context

- Problem: Maintaining dual sources of truth (notebooks + exported `.py`) blocks standard tooling (ruff, mypy, packaging) and makes diff review painful because of nbdev cell noise.
- Use cases: Contributors should edit `.py` modules directly, see human-readable docstrings for the context that used to live in markdown, and no longer run `nbdev_export`.
- Constraints:
  - Keep runtime behaviour identical (imports, `__all__`, registry contents, etc.).
  - Documentation that mattered for onboarding (section headers, parameter explanations) must survive inside the modules.
  - Removing notebooks should not break packaging or CI (no `nbdev` dependency anywhere, no references in docs/rules).

## Requirements

**Files to Create/Modify**

- `README.md` - create a new version based on `index.ipynb` and rules files
- `salk_toolkit/salk_toolkit/*.py` (`io`, `pp`, `plots`, `validation`, `dashboard`, `election_models`, `commands`, `utils`, `_modidx`)  
  - Strip nbdev boilerplate (`# AUTOGENERATED`, `# %% ../nbs/...`), normalize imports, and insert markdown headers as descriptive docstrings or block comments.
- `salk_toolkit/nbs/`
  - Copy any remaining markdown content (section headers, inline explanations) into the owning modules, then delete the `.ipynb` files plus nbdev config files (`nbdev.yml`, `_quarto.yml`, `sidebar.yml`, `styles.css`).
  - Handle `index.ipynb`: if it contains useful documentation, port to README or separate doc file; otherwise delete. 
  - Audit data files (`lhdi.csv`, `lhdi-n.csv`, `test.parquet`, etc.): move to `tests/data/` if test fixtures, to `examples/` if example data, otherwise delete.
- `examples.ipynb` (root level) - standalone examples. Update but keep
- `setup.py` and `settings.ini`
  - Migrate all metadata from `settings.ini` to `pyproject.toml` (`[project]` section): version, author, description, keywords, requirements, console_scripts, etc.
  - `setup.py` as it currently stands. Replace with more lightweight option if needed to keep functionality. 
- `.pre-commit-config.yaml`
  - Remove `export-notebooks` hook (runs `nbdev_export`)
  - Replace `nbdev_docs` hook with `pdoc`
  - Ensure remaining hooks work with direct `.py` editing workflow.
- `_docs/`, `_proc/`, `modidx.py` - Deleteworkflow).
- `.cursor/rules/*.mdc`, specs, and README-like docs  
  - Update any guidance that still references "edit the notebook, export the py".
  - Update `.cursor/rules/salk_toolkit.mdc` line 40-41 which references nbdev autogeneration.
  - Update other specs: `DEV-001-dict-structure.md` line 36, `DEV-002-streamline-explicate.md` line 33, `TOOL-002-json-block-editor.md` line 152.
- `tests/test_plots.py` and other test files
  - Update comments referencing `.ipynb` files (e.g., line 3 in `test_plots.py`) to reference `.py` modules instead. 

**Functionality**

- Preserve module-level API: same `__all__`, same top-level functions/classes, same registry population order, same side effects.
- Promote markdown context:
  - First markdown heading → module docstring (multi-line, keep formatted lists where useful).
  - Intermediate markdown cells that explain large helper sections become inline block comments or `"""Section name"""` docstrings before helper groups.
- Replace nbdev cell markers with the banner delimiter style:
  ```
  # --------------------------------------------------------
  #          PLOT REGISTRATION
  # --------------------------------------------------------
  ```
- Ensure `_modidx.py` or equivalent module discovery still works (either regenerate statically or delete if unused; document the choice).
- Remove any runtime imports from `nbdev.showdoc` or `nbdev` utilities.
- Guarantee git history retains the final notebook content via docstrings before deleting notebooks.

## Implementation Plan

### Foundation Setup

- [x] Inventory every `.ipynb` under `salk_toolkit/nbs` and map them to their exported modules.
- [x] *(Obsolete)* Write a small helper script to extract ordered markdown cells per notebook for easier copy/paste into `.py`. (Not required once notebooks were deleted and modules now host the narrative docstrings.)
- [x] Decide final location for high-level documentation (module docstring vs README) and document the convention in rules.

### Core Development

- [x] For each module, port markdown headers/descriptions into docstrings/comments, then delete nbdev banner + cell markers.
- [x] Remove nbdev imports/config and ensure the packages install/run without nbdev present.
- [x] Handle `index.ipynb`: port useful content into README/module docs, then delete the notebook.
- [x] Audit and relocate data files in `nbs/` (`test.parquet`, `lhdi.csv`, etc.) to appropriate locations or delete.
- [x] Delete the `.ipynb` files plus `nbdev.yml`, `_quarto.yml`, `sidebar.yml`, `styles.css`, and other nbdev artefacts after confirming content was migrated.
- [x] Delete `_docs/` folder (Quarto-generated docs).
- [x] Delete `_proc/` folder if it exists.
- [x] Migrate `settings.ini` metadata to `pyproject.toml` `[project]` section:
  - Version, author, description, keywords, requirements, console_scripts, etc.
  - Ensure version source of truth is consistent (prefer `__init__.py` or `pyproject.toml`).
- [x] Remove version from  `__init__.py`
- [x] Delete `setup.py` (and replace with lightweight option if needed)
- [x] Update tooling/config (`pyproject`, `Makefile`, CI) to stop invoking nbdev export.

### Documentation Workflow

- [x] Adopt the minimal-friction doc pipeline: keep rich Sphinx-style docstrings in modules, add `pdoc` (or equivalent lightweight autodoc) to dev requirements, and document the convention in `.cursor/rules`.
- [x] Standardize on Google-style docstrings (configured via `pdoc`'s `docformat = "google"` in `pyproject.toml`) so contributors know which style to follow when porting notebook commentary.
- [x] Add a simple script or `make docs` target (e.g., `pdoc salk_toolkit -o docs_html`) so contributors can regenerate static HTML locally or in CI without Sphinx scaffolding.
- [x] Docs is a CI artifact, not to be kept in-repo for now
- [x] Streamlit-based tools (`salk_toolkit.tools.explorer` and similar) are excluded/guarded during doc builds so `pdoc` can run headless (`pdoc --output-directory docs_html salk_toolkit !salk_toolkit.tools.explorer` plus runtime guards around `localStorage`/CLI parsing).

### Integration & Testing

- [x] Update `.cursor/rules/*`, specs, and any docs mentioning notebooks as the source of truth:
  - `.cursor/rules/salk_toolkit.mdc` (remove nbdev autogeneration mention)
  - `DEV-001-dict-structure.md` (line 36: "Updated via nbdev export only")
  - `DEV-002-streamline-explicate.md` (line 33: "Updated via nbdev export")
  - `TOOL-002-json-block-editor.md` (line 152: nbdev export reference)
- [x] Update pre-commit hooks in `.pre-commit-config.yaml`:
  - Remove `export-notebooks` hook (line 21-31)
  - Remove `nbdev_docs` hook (line 56-66)
  - Wire Ruff/autopep8/pytest/pdoc hooks directly against `.py` sources.
- [x] Configure Ruff in `pyproject.toml` and pre-commit so only auto-fixable rules run (`E/F/W` families with `--unsafe-fixes`), skip `.ipynb`, and treat Streamlit modules as doc-generation exclusions. This keeps the new pure-Python workflow lintable without manual intervention.
- [x] Update test file comments referencing `.ipynb` files (e.g., `test_plots.py` line 3) to reference `.py` modules.
- [x] Run formatting/lint/tests to confirm modules behave the same without nbdev scaffolding.
- [x] Communicate migration steps (e.g., add README note / Contributing guidance) so contributors know workflow changed.

## Definition of Done

- [x] All docstrings/comments contain the necessary guidance that used to live exclusively in notebooks.
- [x] No nbdev dependency in the repo (code, configs, docs, CI).
- [x] All `.ipynb` files and nbdev config are removed from version control.
- [x] pre-commit flow (Tests, lint, ...) pass when editing `.py` files directly. 
- [x] Rules/specs updated to describe the new workflow.

